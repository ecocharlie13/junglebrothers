<!-- /cultivoapp/relatorio.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Relatório - CultivoApp</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Navbar -->
  <header class="bg-white shadow px-6 py-4 flex justify-between items-center">
    <div class="flex items-center space-x-4">
      <img src="/cultivoapp/assets/logo-junglebrothers.png" alt="Logo" class="h-10" />
      <nav class="space-x-4 text-purple-700 font-semibold">
        <a href="/cultivoapp/blueprints.html">Blueprints</a>
        <a href="/cultivoapp/cultivos.html">Cultivos</a>
        <a href="/cultivoapp/eventos.html">Eventos</a>
        <a href="/cultivoapp/relatorio.html" class="underline">Relatório</a>
      </nav>
    </div>
    <div class="flex items-center gap-4">
      <span id="user-email" class="text-sm text-gray-600">Verificando login...</span>
      <img id="user-pic" class="w-8 h-8 rounded-full" alt="Foto de perfil" />
      <button id="logout" class="bg-red-500 text-white px-4 py-1 rounded">Sair</button>
    </div>
  </header>

  <!-- Conteúdo -->
  <main class="p-6 max-w-6xl mx-auto">
    <!-- Stickers Semanais -->
    <section id="stickers" class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
      <div id="sticker-passada" class="bg-blue-100 border-l-4 border-blue-500 p-4 rounded shadow">
        <h2 class="text-blue-800 font-bold text-lg">Semana Passada</h2>
        <p class="text-sm text-gray-600" id="data-passada">(?? - ??)</p>
        <ul class="mt-2 text-sm text-gray-800" id="lista-passada"></ul>
      </div>
      <div id="sticker-atual" class="bg-yellow-100 border-l-4 border-yellow-500 p-4 rounded shadow">
        <h2 class="text-yellow-800 font-bold text-lg">Semana Atual</h2>
        <p class="text-sm text-gray-600" id="data-atual">(?? - ??)</p>
        <ul class="mt-2 text-sm text-gray-800" id="lista-atual"></ul>
      </div>
      <div id="sticker-seguinte" class="bg-green-100 border-l-4 border-green-500 p-4 rounded shadow">
        <h2 class="text-green-800 font-bold text-lg">Semana Seguinte</h2>
        <p class="text-sm text-gray-600" id="data-seguinte">(?? - ??)</p>
        <ul class="mt-2 text-sm text-gray-800" id="lista-seguinte"></ul>
      </div>
    </section>
  </main>

  <script type="module">
    import { auth, db } from "/cultivoapp/js/firebase-init.js";
    import { verificarLogin, sair } from "/cultivoapp/js/auth.js";
    import {
      collection, doc, getDoc, getDocs, query, where
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const emailSpan = document.getElementById("user-email");
    const picImg = document.getElementById("user-pic");
    const logoutBtn = document.getElementById("logout");

    verificarLogin(async (user) => {
      emailSpan.textContent = user.email;
      picImg.src = user.photoURL;
      logoutBtn.addEventListener("click", sair);

      const hoje = new Date();
      const diaDaSemana = hoje.getDay();
      const diffInicio = hoje.getDate() - diaDaSemana;

      const inicioSemana = new Date(hoje.setDate(diffInicio));
      const fimSemana = new Date(hoje.setDate(inicioSemana.getDate() + 6));
      const passadaInicio = new Date(inicioSemana);
      passadaInicio.setDate(inicioSemana.getDate() - 7);
      const passadaFim = new Date(inicioSemana);
      passadaFim.setDate(inicioSemana.getDate() - 1);
      const seguinteInicio = new Date(fimSemana);
      seguinteInicio.setDate(fimSemana.getDate() + 1);
      const seguinteFim = new Date(fimSemana);
      seguinteFim.setDate(fimSemana.getDate() + 7);

      const formatar = (d) => d.toLocaleDateString("pt-BR", { day: '2-digit', month: 'short' });
      document.getElementById("data-passada").textContent = `(${formatar(passadaInicio)} - ${formatar(passadaFim)})`;
      document.getElementById("data-atual").textContent = `(${formatar(inicioSemana)} - ${formatar(fimSemana)})`;
      document.getElementById("data-seguinte").textContent = `(${formatar(seguinteInicio)} - ${formatar(seguinteFim)})`;

      const selecionados = JSON.parse(localStorage.getItem("cultivosSelecionados")) || [];
      for (const id of selecionados) {
        const snap = await getDoc(doc(db, "cultivos", id));
        if (!snap.exists()) continue;
        const cultivo = snap.data();
        const inicio = new Date(cultivo.data);

        cultivo.eventos.forEach((evento, idx) => {
          const dataInicio = new Date(inicio);
          dataInicio.setDate(dataInicio.getDate() + (evento.ajuste || 0));
          const dataFim = new Date(dataInicio);
          dataFim.setDate(dataFim.getDate() + evento.dias);

          const item = document.createElement("li");
          item.textContent = `- ${cultivo.titulo}\n-- ${evento.nome} / ${formatar(dataFim)}`;

          if (dataFim < passadaInicio || dataInicio > seguinteFim) return;

          if (dataFim <= passadaFim) {
            document.getElementById("lista-passada").appendChild(item);
          } else if (dataInicio >= inicioSemana && dataFim <= fimSemana) {
            document.getElementById("lista-atual").appendChild(item);
          } else if (dataInicio >= seguinteInicio && dataFim <= seguinteFim) {
            document.getElementById("lista-seguinte").appendChild(item);
          }
        });
      }
    });
  </script>
</body>
</html>
