<script type="module">
  import { auth, db } from "/cultivoapp/js/firebase-init.js";
  import { verificarLogin, sair } from "/cultivoapp/js/auth.js";
  import { getDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

  let eventosMap = {};
  let cultivosSelecionados = [];

  verificarLogin(async (user) => {
    document.getElementById("user-email").textContent = user.email;
    document.getElementById("user-pic").src = user.photoURL;
    document.getElementById("logout").addEventListener("click", sair);

    cultivosSelecionados = JSON.parse(localStorage.getItem("cultivosSelecionados")) || [];
    for (const cultivoId of cultivosSelecionados) {
      const snap = await getDoc(doc(db, "cultivos", cultivoId));
      if (snap.exists()) eventosMap[cultivoId] = snap.data();
    }

    atualizarTabela();
  });

  function formatarData(data) {
    const meses = ["jan", "fev", "mar", "abr", "mai", "jun", "jul", "ago", "set", "out", "nov", "dez"];
    return `${data.getDate().toString().padStart(2, '0')} ${meses[data.getMonth()]} ${data.getFullYear()}`;
  }

  function atualizarTabela() {
    const tbody = document.getElementById("tabela-eventos");
    tbody.innerHTML = "";

    for (const [cultivoId, cultivo] of Object.entries(eventosMap)) {
      let inicio = new Date(cultivo.data);

      cultivo.eventos.forEach((ev, i) => {
        const fim = new Date(inicio);
        fim.setDate(fim.getDate() + (parseInt(ev.dias) || 0));

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="border px-2 py-1">${cultivo.titulo}</td>
          <td class="border px-2 py-1">${ev.evento}</td>
          <td class="border px-2 py-1">
            <input class="dias w-16 px-1 border rounded" type="number" value="${ev.dias}" data-cultivo="${cultivoId}" data-index="${i}" />
          </td>
          <td class="border px-2 py-1">${formatarData(inicio)}</td>
          <td class="border px-2 py-1">${formatarData(fim)}</td>
          <td class="border px-2 py-1">
            <input class="notas w-full px-1 border rounded" value="${ev.notas || ""}" data-cultivo="${cultivoId}" data-index="${i}" />
          </td>
        `;
        tbody.appendChild(tr);

        inicio = new Date(fim); // encadeia o prÃ³ximo evento
      });
    }
  }

  document.getElementById("atualizar").addEventListener("click", async () => {
    document.querySelectorAll(".dias").forEach(input => {
      const { cultivo, index } = input.dataset;
      eventosMap[cultivo].eventos[index].dias = parseInt(input.value);
    });

    document.querySelectorAll(".notas").forEach(input => {
      const { cultivo, index } = input.dataset;
      eventosMap[cultivo].eventos[index].notas = input.value;
    });

    for (const [cultivoId, cultivo] of Object.entries(eventosMap)) {
      await updateDoc(doc(db, "cultivos", cultivoId), { eventos: cultivo.eventos });
    }

    atualizarTabela();
    alert("Eventos atualizados com sucesso!");
  });
</script>
