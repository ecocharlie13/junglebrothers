
function Gantt(selector, tarefas, options = {}) {
  const container = document.querySelector(selector);
  container.innerHTML = "";

  const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", tarefas.length * 40 + 50);
  svg.style.background = "#fff";
  container.appendChild(svg);

  const barHeight = 20;
  const dayWidth = 20;
  const yStart = 30;

  // Agrupar tarefas por cultivo
  const grupos = {};
  tarefas.forEach(t => {
    const cultivo = t.id.split("-")[0];
    if (!grupos[cultivo]) grupos[cultivo] = [];
    grupos[cultivo].push({ ...t });
  });

  // Encadear datas por cultivo
  const tarefasProcessadas = [];
  Object.keys(grupos).forEach(cultivo => {
    const eventos = grupos[cultivo];
    eventos.sort((a, b) => parseInt(a.id.split("-")[1]) - parseInt(b.id.split("-")[1]));
    let dataBase = new Date(eventos[0].start);
    eventos.forEach(ev => {
      const inicio = new Date(dataBase);
      const fim = new Date(inicio);
      fim.setDate(fim.getDate() + (parseInt(ev.end.split("-")[2]) - parseInt(ev.start.split("-")[2])));
      tarefasProcessadas.push({
        ...ev,
        _start: new Date(inicio),
        _end: new Date(fim)
      });
      dataBase = new Date(fim);
    });
  });

  // Pegar menor data para alinhar o grÃ¡fico
  const minDate = new Date(Math.min(...tarefasProcessadas.map(t => t._start.getTime())));

  tarefasProcessadas.forEach((task, index) => {
    const x = (task._start - minDate) / (1000 * 60 * 60 * 24) * dayWidth + 30;
    const width = Math.max(1, (task._end - task._start) / (1000 * 60 * 60 * 24)) * dayWidth;
    const y = yStart + index * 40;

    const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
    rect.setAttribute("x", x);
    rect.setAttribute("y", y);
    rect.setAttribute("width", width);
    rect.setAttribute("height", barHeight);
    rect.setAttribute("fill", "#4ade80");
    rect.setAttribute("rx", "4");
    svg.appendChild(rect);

    const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
    text.setAttribute("x", x + 4);
    text.setAttribute("y", y + barHeight / 1.5);
    text.setAttribute("font-size", "12px");
    text.setAttribute("fill", "black");
    text.textContent = task.name;
    svg.appendChild(text);
  });

  console.log("Gantt com encadeamento aplicado");
}
window.Gantt = Gantt;
