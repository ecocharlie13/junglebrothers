window.Gantt = class {
  constructor(selector, tasks) {
    const container = document.querySelector(selector);
    container.innerHTML = "";

    const cores = ["#c084fc", "#4ade80", "#60a5fa", "#facc15", "#f472b6"];
    const grupos = {};

    // Agrupar tarefas por cultivo
    const porCultivo = {};
    tasks.forEach(t => {
      if (!porCultivo[t.cultivo]) porCultivo[t.cultivo] = [];
      porCultivo[t.cultivo].push(t);
    });

    // Determinar cores por cultivo
    const nomesCultivo = Object.keys(porCultivo);
    nomesCultivo.forEach((nome, i) => grupos[nome] = cores[i % cores.length]);

    // Obter data inicial e final total
    let datas = tasks.flatMap(t => [new Date(t.start), new Date(t.end)]);
    const minDate = new Date(Math.min(...datas));
    const maxDate = new Date(Math.max(...datas));

    // Ajustar para começar no domingo
    minDate.setDate(minDate.getDate() - minDate.getDay());

    // Calcular semanas
    const semanas = [];
    let atual = new Date(minDate);
    while (atual <= maxDate) {
      semanas.push(new Date(atual));
      atual.setDate(atual.getDate() + 7);
    }

    // Cabeçalho com legenda e semanas
    const header = document.createElement("div");
    header.className = "flex flex-wrap items-center gap-4 mb-2";

    nomesCultivo.forEach(nome => {
      const cor = grupos[nome];
      const inicio = porCultivo[nome][0].start;
      const fim = porCultivo[nome].at(-1).end;
      const legenda = document.createElement("div");
      legenda.className = "flex items-center gap-2 text-sm";
      legenda.innerHTML = `<span class='w-4 h-4 rounded inline-block' style='background:${cor}'></span> ${nome} (${formatar(inicio)} – ${formatar(fim)})`;
      header.appendChild(legenda);
    });

    container.appendChild(header);

    // Semana timeline
    const timeline = document.createElement("div");
    timeline.className = "flex text-xs font-semibold border-t border-b border-gray-300";
    semanas.forEach((sem, i) => {
      const semanaDiv = document.createElement("div");
      semanaDiv.className = `text-center py-1 ${i % 2 === 0 ? 'bg-gray-100' : 'bg-white'}`;
      semanaDiv.textContent = `Semana ${getWeek(sem)}`;
      semanaDiv.style.flex = "1";
      timeline.appendChild(semanaDiv);
    });
    container.appendChild(timeline);

    // Área de tarefas
    const corpo = document.createElement("div");
    corpo.className = "border-l border-gray-300";

    nomesCultivo.forEach(nome => {
      const linha = document.createElement("div");
      linha.className = "flex items-center text-xs h-10";

      semanas.forEach((semana, i) => {
        const bloco = document.createElement("div");
        bloco.className = `${i % 2 === 0 ? 'bg-gray-50' : 'bg-white'}`;
        bloco.style.flex = "1";
        bloco.style.height = "100%";
        linha.appendChild(bloco);
      });

      porCultivo[nome].forEach(evento => {
        const eInicio = new Date(evento.start);
        const eFim = new Date(evento.end);

        const totalSemanas = semanas.length;
        const totalDias = (maxDate - minDate) / (1000 * 60 * 60 * 24);
        const leftPercent = ((eInicio - minDate) / (1000 * 60 * 60 * 24)) / totalDias * 100;
        const widthPercent = ((eFim - eInicio) / (1000 * 60 * 60 * 24)) / totalDias * 100;

        const barra = document.createElement("div");
        barra.className = "absolute text-white text-center py-0.5 rounded shadow-sm overflow-hidden whitespace-nowrap";
        barra.style.position = "absolute";
        barra.style.left = `${leftPercent}%`;
        barra.style.width = `${widthPercent}%`;
        barra.style.background = grupos[nome];
        barra.style.height = "1.5rem";
        barra.textContent = evento.name;

        const inicioSpan = document.createElement("span");
        inicioSpan.className = "absolute left-0 -translate-x-full pr-1 text-gray-500";
        inicioSpan.textContent = formatar(evento.start);

        const fimSpan = document.createElement("span");
        fimSpan.className = "absolute right-0 translate-x-full pl-1 text-gray-500";
        fimSpan.textContent = formatar(evento.end);

        linha.appendChild(inicioSpan);
        linha.appendChild(barra);
        linha.appendChild(fimSpan);
      });

      corpo.appendChild(linha);
    });

    container.appendChild(corpo);

    function formatar(iso) {
      const meses = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
      const d = new Date(iso);
      return `${d.getDate().toString().padStart(2, "0")} ${meses[d.getMonth()]}`;
    }

    function getWeek(d) {
      const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = date.getUTCDay() || 7;
      date.setUTCDate(date.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
      return Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
    }
  }
};
