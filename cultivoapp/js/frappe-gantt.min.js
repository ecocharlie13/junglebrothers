function Gantt(selector, tarefas) {
  const container = document.querySelector(selector);
  container.innerHTML = "";

  const barHeight = 20;
  const dayWidth = 20;
  const paddingLeft = 100;
  const yStart = 60;

  const grupos = {};
  tarefas.forEach(t => {
    const cultivo = t.id.split("-")[0];
    if (!grupos[cultivo]) grupos[cultivo] = [];
    grupos[cultivo].push({ ...t });
  });

  const eventos = [];
  Object.keys(grupos).forEach(cultivo => {
    const evs = grupos[cultivo];
    evs.sort((a, b) => parseInt(a.id.split("-")[1]) - parseInt(b.id.split("-")[1]));
    let dataBase = new Date(evs[0].start);
    evs.forEach((e, i) => {
      const inicio = new Date(dataBase);
      const dur = Math.max(1, (new Date(e.end) - new Date(e.start)) / (1000 * 60 * 60 * 24));
      const fim = new Date(inicio);
      fim.setDate(fim.getDate() + dur);
      eventos.push({
        ...e,
        _start: new Date(inicio),
        _end: new Date(fim),
        _codigo: `${cultivo} - ${String(i + 1).padStart(2, '0')}`,
        _dur: dur
      });
      dataBase = new Date(fim);
    });
  });

  const min = new Date(Math.min(...eventos.map(e => e._start)));
  const max = new Date(Math.max(...eventos.map(e => e._end)));
  const diasTotal = (max - min) / (1000 * 60 * 60 * 24) + 1;

  const svgWidth = paddingLeft + diasTotal * dayWidth;
  const svgHeight = eventos.length * 40 + 100;

  const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  svg.setAttribute("width", svgWidth);
  svg.setAttribute("height", svgHeight);
  svg.style.background = "#fff";
  container.appendChild(svg);

  // Eixo de datas
  for (let i = 0; i < diasTotal; i++) {
    const data = new Date(min);
    data.setDate(data.getDate() + i);
    if (data.getDate() === 1 || i % 7 === 0) {
      const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
      text.setAttribute("x", paddingLeft + i * dayWidth);
      text.setAttribute("y", 30);
      text.setAttribute("font-size", "10px");
      text.setAttribute("fill", "#666");
      text.textContent = data.toLocaleDateString("pt-BR", { day: "2-digit", month: "short" });
      svg.appendChild(text);
    }
  }

  // Paleta padrão
  const cores = ["#60a5fa", "#facc15", "#34d399", "#a78bfa", "#fb7185", "#f97316", "#2dd4bf"];

  eventos.forEach((e, idx) => {
    const x = paddingLeft + (e._start - min) / (1000 * 60 * 60 * 24) * dayWidth;
    const w = e._dur * dayWidth;
    const y = yStart + idx * 40;

    const cor = cores[idx % cores.length];

    const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
    rect.setAttribute("x", x);
    rect.setAttribute("y", y);
    rect.setAttribute("width", w);
    rect.setAttribute("height", barHeight);
    rect.setAttribute("rx", "4");
    rect.setAttribute("fill", cor);
    rect.setAttribute("stroke", "#333");
    rect.setAttribute("stroke-width", "0.2");
    svg.appendChild(rect);

    const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
    text.setAttribute("x", x + 4);
    text.setAttribute("y", y + barHeight / 1.5);
    text.setAttribute("font-size", "11px");
    text.setAttribute("fill", "black");
    text.textContent = `${e._codigo} ${e.name}`;
    svg.appendChild(text);
  });

  // Exporta o SVG para uso externo
  Gantt.getXCoordinateForDate = function (isoString) {
    const target = new Date(isoString);
    const dias = (target - min) / (1000 * 60 * 60 * 24);
    return paddingLeft + dias * dayWidth;
  };

  console.log("✅ Gantt renderizado com layout corrigido e escalado corretamente.");
}

window.Gantt = Gantt;
