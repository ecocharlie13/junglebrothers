window.Gantt = class {
  constructor(selector, tasks) {
    const container = document.querySelector(selector);
    container.innerHTML = "";

    const cores = ["#c084fc", "#4ade80", "#60a5fa", "#facc15", "#f472b6"];
    const grupos = {};
    const tarefas = [...tasks];

    // Agrupar por cultivo
    tarefas.forEach(t => {
      const grupo = t.id.split("-")[0];
      if (!grupos[grupo]) {
        grupos[grupo] = cores[Object.keys(grupos).length % cores.length];
      }
    });

    // Determinar intervalo do gr√°fico
    const todasDatas = tarefas.flatMap(t => [new Date(t.start), new Date(t.end)]);
    const dataMin = new Date(Math.min(...todasDatas));
    const dataMax = new Date(Math.max(...todasDatas));
    const diasTotais = Math.ceil((dataMax - dataMin) / (1000 * 60 * 60 * 24)) + 1;

    // Cabe√ßalho com linha do tempo
    const escala = document.createElement("div");
    escala.className = "flex text-xs text-gray-500 sticky top-0 bg-gray-100 z-10";
    for (let i = 0; i < diasTotais; i++) {
      const d = new Date(dataMin);
      d.setDate(d.getDate() + i);
      const dia = d.getDate().toString().padStart(2, "0");
      const mes = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"][d.getMonth()];
      const cell = document.createElement("div");
      cell.className = "w-[20px] text-center";
      cell.textContent = dia === "01" ? `${dia} ${mes}` : dia;
      escala.appendChild(cell);
    }
    container.appendChild(escala);

    // Indicador de hoje
    const hoje = new Date().toISOString().split("T")[0];
    const hojeLabel = document.createElement("div");
    hojeLabel.className = "text-sm text-gray-600 my-2";
    hojeLabel.innerHTML = `<span class='text-red-600'>üìç Hoje:</span> ${hoje}`;
    container.appendChild(hojeLabel);

    // Gera√ß√£o das barras
    tarefas.forEach(task => {
      const linha = document.createElement("div");
      linha.className = "flex items-center mb-2 text-xs relative";

      const cor = grupos[task.id.split("-")[0]];
      const diasInicio = Math.floor((new Date(task.start) - dataMin) / (1000 * 60 * 60 * 24));
      const diasDuracao = Math.max(1, Math.floor((new Date(task.end) - new Date(task.start)) / (1000 * 60 * 60 * 24)));

      const inicio = document.createElement("div");
      inicio.className = "w-[80px] text-right pr-2 text-gray-500";
      inicio.textContent = formatar(task.start);

      const barraWrapper = document.createElement("div");
      barraWrapper.className = "flex-1 relative";
      const barra = document.createElement("div");
      barra.textContent = task.name;
      barra.className = "absolute text-white text-center py-1 px-1 rounded text-xs truncate";
      barra.style.left = `${diasInicio * 20}px`;
      barra.style.width = `${diasDuracao * 20}px`;
      barra.style.backgroundColor = cor;

      barraWrapper.appendChild(barra);

      const fim = document.createElement("div");
      fim.className = "w-[80px] pl-2 text-gray-500";
      fim.textContent = formatar(task.end);

      linha.appendChild(inicio);
      linha.appendChild(barraWrapper);
      linha.appendChild(fim);
      container.appendChild(linha);
    });

    function formatar(iso) {
      const d = new Date(iso);
      const meses = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
      return `${d.getDate().toString().padStart(2, "0")} ${meses[d.getMonth()]}`;
    }
  }
};
