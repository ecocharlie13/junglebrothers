import { auth, db } from "/cultivoapp/js/firebase-init.js";
import { verificarLogin, sair } from "/cultivoapp/js/auth.js";
import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

// Função utilitária para converter "2024-06-01" em "01 jun"
function formatarDataCurta(iso) {
  const data = new Date(iso);
  return data.toLocaleDateString("pt-BR", {
    day: "2-digit",
    month: "short",
  });
}

// Calcula o intervalo de uma semana
function obterIntervaloSemana(offset = 0) {
  const hoje = new Date();
  const diaDaSemana = hoje.getDay(); // 0 (domingo) a 6 (sábado)
  const domingo = new Date(hoje);
  domingo.setDate(hoje.getDate() - diaDaSemana + (offset * 7));
  const sabado = new Date(domingo);
  sabado.setDate(domingo.getDate() + 6);
  return [domingo, sabado];
}

// Preenche um sticker com os eventos
function preencherSticker(stickerId, dataId, listaId, eventos, dataInicio, dataFim) {
  document.getElementById(dataId).textContent =
    `${formatarDataCurta(dataInicio.toISOString())} - ${formatarDataCurta(dataFim.toISOString())}`;

  const ul = document.getElementById(listaId);
  ul.innerHTML = "";

  eventos.forEach(({ cultivo, evento }) => {
    const liCultivo = document.createElement("li");
    liCultivo.className = "font-semibold";
    liCultivo.textContent = `• ${cultivo}`;

    const liEvento = document.createElement("li");
    liEvento.className = "ml-4";
    liEvento.textContent = `- ${evento.nome} / ${formatarDataCurta(evento.data_fim)}`;

    ul.appendChild(liCultivo);
    ul.appendChild(liEvento);
  });
}

// Função principal
verificarLogin(async (user) => {
  const selecionados = JSON.parse(localStorage.getItem("cultivosSelecionados")) || [];

  const todosEventos = [];

  for (const cultivoId of selecionados) {
    const ref = doc(db, "cultivos", cultivoId);
    const snap = await getDoc(ref);

    if (snap.exists()) {
      const cultivo = snap.data();
      const dataInicial = new Date(cultivo.data);
      const eventos = cultivo.eventos || [];

      let acumulado = new Date(dataInicial);

      for (const evento of eventos) {
        const dias = parseInt(evento.dias || 0);
        const ajuste = parseInt(evento.ajuste || 0);
        const dataInicio = new Date(acumulado);
        dataInicio.setDate(dataInicio.getDate() + ajuste);

        const dataFim = new Date(dataInicio);
        dataFim.setDate(dataInicio.getDate() + dias);

        todosEventos.push({
          cultivo: cultivo.titulo || cultivoId,
          evento: {
            nome: evento.nome,
            data_inicio: dataInicio.toISOString(),
            data_fim: dataFim.toISOString()
          }
        });

        acumulado = new Date(dataFim);
      }
    }
  }

  const [semanaPassadaIni, semanaPassadaFim] = obterIntervaloSemana(-1);
  const [semanaAtualIni, semanaAtualFim] = obterIntervaloSemana(0);
  const [semanaSeguinteIni, semanaSeguinteFim] = obterIntervaloSemana(1);

  const eventosPassados = todosEventos.filter(e => {
    const fim = new Date(e.evento.data_fim);
    return fim >= semanaPassadaIni && fim <= semanaPassadaFim;
  });

  const eventosAtuais = todosEventos.filter(e => {
    const fim = new Date(e.evento.data_fim);
    return fim >= semanaAtualIni && fim <= semanaAtualFim;
  });

  const eventosSeguintes = todosEventos.filter(e => {
    const fim = new Date(e.evento.data_fim);
    return fim >= semanaSeguinteIni && fim <= semanaSeguinteFim;
  });

  preencherSticker("sticker-passada", "data-passada", "lista-passada", eventosPassados, semanaPassadaIni, semanaPassadaFim);
  preencherSticker("sticker-atual", "data-atual", "lista-atual", eventosAtuais, semanaAtualIni, semanaAtualFim);
  preencherSticker("sticker-seguinte", "data-seguinte", "lista-seguinte", eventosSeguintes, semanaSeguinteIni, semanaSeguinteFim);
});
